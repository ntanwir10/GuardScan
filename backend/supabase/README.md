# GuardScan Supabase Setup

Open-source telemetry and monitoring database for GuardScan CLI.

## Overview

This database schema supports:
- **Privacy-preserving telemetry** - No source code, no file paths, no PII
- **Error tracking** - Debug CLI issues with full context
- **Performance metrics** - Monitor execution times and resource usage
- **Usage analytics** - Understand how GuardScan is being used
- **System health** - Real-time health status and alerts

## Quick Start

### 1. Create Supabase Project

1. Go to [supabase.com](https://supabase.com)
2. Sign in and create a new project
3. Wait ~2 minutes for provisioning
4. Save your credentials:
   - **Project URL**: `https://xxxxx.supabase.co`
   - **Service Role Key**: Found in Settings → API

### 2. Apply Migrations

In Supabase Dashboard → **SQL Editor**, run these migrations in order:

**Step 1: Core Schema**
```sql
-- Copy entire contents of migrations/001_core_schema.sql
-- Paste and run in SQL Editor
```

**Step 2: Monitoring & Security**
```sql
-- Copy entire contents of migrations/002_monitoring_and_security.sql
-- Paste and run in SQL Editor
```

### 3. Verify Tables Created

Go to **Table Editor** and verify these 6 tables exist:
- ✅ `clients` - CLI user tracking
- ✅ `telemetry` - Usage events
- ✅ `errors` - Error tracking
- ✅ `metrics` - Performance metrics
- ✅ `usage_events` - Command analytics
- ✅ `health_checks` - System health

### 4. Configure Backend

Set environment variables for local development:

```bash
cd backend
cat > .dev.vars << 'EOF'
SUPABASE_URL=https://xxxxx.supabase.co
SUPABASE_KEY=your_service_role_key_here
EOF
```

**Important**: Replace with your actual Supabase credentials!

### 5. Test Connection

Start backend and test:

```bash
# Terminal 1: Start backend
npm run dev

# Terminal 2: Test telemetry endpoint
curl -X POST http://localhost:8787/api/telemetry \
  -H "Content-Type: application/json" \
  -d '{
    "clientId": "test-client-123",
    "repoId": "test-repo-456",
    "events": [{
      "action": "scan",
      "loc": 100,
      "durationMs": 1000,
      "model": "gpt-4",
      "timestamp": 1700000000000,
      "metadata": {}
    }],
    "cliVersion": "1.0.0"
  }'
```

Expected response: `{"status":"ok"}`

### 6. Verify Data in Supabase

Go to **Table Editor** → **clients**:
- Should see a new row with `client_id = test-client-123`

Go to **Table Editor** → **telemetry**:
- Should see 1 event with the data you sent

## Schema Overview

### Core Tables

#### `clients`
Tracks unique CLI installations.

| Column | Type | Description |
|--------|------|-------------|
| client_id | TEXT (PK) | UUID generated by CLI |
| created_at | TIMESTAMPTZ | First seen |
| last_seen_at | TIMESTAMPTZ | Last activity |
| cli_version | TEXT | CLI version |
| metadata | JSONB | Additional data |

#### `telemetry`
Privacy-preserving usage events.

| Column | Type | Description |
|--------|------|-------------|
| event_id | UUID (PK) | Auto-generated |
| client_id | TEXT (FK) | References clients |
| repo_id | TEXT | Anonymized repo hash |
| action_type | TEXT | Command executed |
| duration_ms | INTEGER | Execution time |
| model | TEXT | AI model used |
| loc | INTEGER | Lines of code processed |
| timestamp | TIMESTAMPTZ | Event time |
| metadata | JSONB | Additional data |

### Monitoring Tables

#### `errors`
Error tracking with full context.

| Column | Type | Description |
|--------|------|-------------|
| id | UUID (PK) | Auto-generated |
| error_id | TEXT | Unique error ID |
| timestamp | TIMESTAMPTZ | When error occurred |
| severity | TEXT | low, medium, high, critical |
| message | TEXT | Error message |
| stack | TEXT | Stack trace |
| context | JSONB | Error context |
| environment | JSONB | System info |

#### `metrics`
Performance metrics.

| Column | Type | Description |
|--------|------|-------------|
| id | UUID (PK) | Auto-generated |
| metric_id | TEXT | Unique metric ID |
| timestamp | TIMESTAMPTZ | When measured |
| name | TEXT | Metric name |
| value | NUMERIC | Metric value |
| unit | TEXT | ms, MB, count, LOC/sec |
| tags | JSONB | Additional tags |

#### `usage_events`
Command execution tracking.

| Column | Type | Description |
|--------|------|-------------|
| id | UUID (PK) | Auto-generated |
| event_id | TEXT | Unique event ID |
| timestamp | TIMESTAMPTZ | When executed |
| command | TEXT | CLI command |
| duration | INTEGER | Duration in ms |
| success | BOOLEAN | Completed successfully |
| client_id | TEXT | Which client |
| metadata | JSONB | Additional data |

#### `health_checks`
System health monitoring.

| Column | Type | Description |
|--------|------|-------------|
| id | UUID (PK) | Auto-generated |
| timestamp | TIMESTAMPTZ | Check time |
| status | TEXT | healthy, degraded, unhealthy |
| checks | JSONB | Check results |
| details | JSONB | Additional details |

### Analytics Views

#### `error_summary`
Hourly error aggregation by severity (last 7 days).

```sql
SELECT * FROM error_summary 
ORDER BY hour DESC 
LIMIT 10;
```

#### `performance_summary`
Metrics with percentiles (p50, p95, p99) by hour.

```sql
SELECT * FROM performance_summary 
WHERE metric_name = 'scan_duration'
ORDER BY hour DESC 
LIMIT 10;
```

#### `usage_summary`
Command statistics with success rates.

```sql
SELECT * FROM usage_summary 
ORDER BY hour DESC, execution_count DESC 
LIMIT 10;
```

### Utility Functions

#### `cleanup_old_monitoring_data(retention_days)`
Removes monitoring data older than specified days.

```sql
-- Clean up data older than 30 days
SELECT * FROM cleanup_old_monitoring_data(30);
```

#### `get_system_health()`
Returns current system health status.

```sql
-- Check system health
SELECT * FROM get_system_health();
```

## Security

### Row Level Security (RLS)

All tables have RLS enabled with strict access control:

- **Service Role**: Full access (backend API)
- **Authenticated Users**: No access (privacy-preserving)
- **Public**: No access

This ensures:
- ✅ Only backend can write/read data
- ✅ Users cannot query telemetry directly
- ✅ Privacy is preserved

### Best Practices

1. **Never expose service_role key** - Keep it secret in environment variables
2. **Use service_role only in backend** - Never in CLI or client apps
3. **Rotate keys regularly** - Generate new keys in Supabase dashboard
4. **Monitor access logs** - Check Supabase dashboard for unusual activity

## Deployment

### Production Setup

1. **Create production Supabase project**
2. **Apply migrations** (same as above)
3. **Set Cloudflare secrets**:

```bash
cd backend
wrangler secret put SUPABASE_URL
# Enter: https://xxxxx.supabase.co

wrangler secret put SUPABASE_KEY
# Enter: your_service_role_key
```

4. **Deploy backend**:

```bash
wrangler deploy --env production
```

### Staging Setup

```bash
# Set staging secrets
wrangler secret put SUPABASE_URL --env staging
wrangler secret put SUPABASE_KEY --env staging

# Deploy to staging
wrangler deploy --env staging
```

## Monitoring

### Database Queries

```sql
-- Recent telemetry events
SELECT * FROM telemetry 
ORDER BY timestamp DESC 
LIMIT 20;

-- Active clients (last 24h)
SELECT client_id, cli_version, last_seen_at 
FROM clients 
WHERE last_seen_at >= NOW() - INTERVAL '24 hours'
ORDER BY last_seen_at DESC;

-- Error rate (last hour)
SELECT severity, COUNT(*) 
FROM errors 
WHERE timestamp >= NOW() - INTERVAL '1 hour'
GROUP BY severity;

-- Command usage (last 24h)
SELECT action_type, COUNT(*), AVG(duration_ms)
FROM telemetry 
WHERE timestamp >= NOW() - INTERVAL '24 hours'
GROUP BY action_type
ORDER BY COUNT(*) DESC;
```

### Backend API Endpoints

```bash
# Get monitoring stats
curl https://your-worker.workers.dev/api/monitoring/stats?hours=24

# Check system health
curl https://your-worker.workers.dev/health
```

## Maintenance

### Data Retention

Run cleanup monthly to manage database size:

```sql
-- In Supabase SQL Editor
SELECT * FROM cleanup_old_monitoring_data(30);
```

Or schedule via Supabase Dashboard → **Database** → **Cron Jobs**:

```sql
-- Run daily at 2 AM
SELECT cron.schedule(
    'cleanup-monitoring-data',
    '0 2 * * *',
    $$SELECT cleanup_old_monitoring_data(30)$$
);
```

### Backup

Supabase automatically backs up your database daily. To download:

1. Go to **Settings** → **Backups**
2. Download latest backup
3. Store securely

## Troubleshooting

### "Database query failed"

**Check:**
- Supabase URL is correct
- Service role key is valid
- Migrations were applied successfully

### "Permission denied"

**Check:**
- Using service_role key (not anon key)
- RLS policies are in place
- Grants are correct

### "Table does not exist"

**Solution:**
- Re-apply migrations in order
- Check for errors in SQL Editor

### "Rate limit exceeded" (from backend)

**This is expected!** Rate limiting is working correctly:
- Telemetry: 100 requests/min per client
- Monitoring: 50 requests/min per client

## Support

- **Issues**: [GitHub Issues](https://github.com/your-org/guardscan/issues)
- **Documentation**: See `/docs` folder
- **Backend**: See `/backend/README.md`

---

**Privacy First** | **Open Source** | **Free Forever**

